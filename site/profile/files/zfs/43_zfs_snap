#!/bin/bash
# This file provides an easy way to add custom menu entries.  Simply type the
# menu entries you want to add after this comment.  Be careful not to change
# the 'exec tail' line above.
#menuentry 'Ubuntu (snapshot)' {
#        linux   /ROOT/bravo/@zfsroot/boot/vmlinuz-3.13.0-32-generic root=ZFS=POOL/ROOT/bravo@zfsroot ro boot=zfs
#        initrd  /ROOT/bravo/@zfsroot/boot/initrd.img-3.13.0-32-generic
#}
MNTINFO=$(mount | grep 'on / type')
[[ ${MNTINFO} = *zfs* ]] || exit 0
# we have a zfs root file system

BOOTEDROOT=${MNTINFO%% *}
oIFS=$IFS
IFS=/ PARTS=( ${BOOTEDROOT} )
IFS=$oIFS
POOL=${PARTS[0]}
BEDS=${PARTS[1]}
BE=${PARTS[2]}

MNTDIR=/tmp/grub$$
mkdir ${MNTDIR} || true

[[ -f /etc/default/grub ]] && . /etc/default/grub
DIST=${GRUB_DISTRIBUTOR:-"Linux"}

declare -i first=0

for fs in $(zfs list -H -r -p -t all -o name $POOL/${BEDS} | tac)
do
	rootfs=${fs%%@*}
	be=${rootfs##*/}
	snapname=${fs#*@}
	if [[ ${snapname} != ${fs} ]]
	then
		entry=$snapname/
        else
		entry=
	fi
	mount -t zfs ${fs} ${MNTDIR} 2>/dev/null || continue
	if [ ! -d ${MNTDIR}/boot/ ]
	then
		umount ${MNTDIR}
		continue
	fi

	for version in $(cd ${MNTDIR}/boot; ls vmlinuz-* | grep -v old-dkms | tac)
	do
		version=$(echo $version | sed 's/^vmlinuz-//')
		if [ $first -eq 0 ] 
		then
			echo Found ZFS snapshots to include in menu >&2
			echo "# Auto generated zfs snapshot entries"
			echo
			echo "submenu 'ZFS snapshot boot options for $DIST' {"
			first=1
		fi

		if [[ -f ${MNTDIR}/boot/vmlinuz-$version && -f ${MNTDIR}/boot/initrd.img-$version ]] 
		then
			echo "Found linux image: $fs/boot/vmlinuz-$version" >&2
			echo Found initrd image: $fs/boot/initrd.img-$version >&2
			echo "	menuentry '$fs $version ($(zfs list -H -o creation $fs))' {"
			echo "		linux   /${BEDS}/${be}/@${entry}boot/vmlinuz-$version root=ZFS=$fs ro boot=zfs"
			echo "		initrd  /${BEDS}/${be}/@${entry}boot/initrd.img-$version"
			echo "	}"
		fi
	done
	umount ${MNTDIR}
done
rmdir ${MNTDIR}

[[ $first -ne 0 ]] && echo "}" 
exit 0
